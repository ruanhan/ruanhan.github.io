<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#1.0.0'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>go_web - Hexo</title>
  
    <meta name="keywords" content="guide">
  
  
    <meta name="description" content="go web">
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13/css/all.min.css">
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  

  

  <!-- import link -->
  

  
  
    
<link rel="stylesheet" href="/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<header class="l_header shadow blur">
  <div class='container'>
  <div class='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h'>
        <li><a class="s-comment fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
          
          
          
            BELIEF <b><sup style='color:#3AA757'>1.0.0</sup></b>
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h'>
          
          
          
            
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>

			<ul class='switcher nav-list-h'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

<script>setLoadingBarProgress(40);</script>



  <div class="l_body nocover">
    <div class='body-wrapper'>
      

<div class='l_main'>
  

  
    <article id="post" class="post white-box reveal shadow article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h1 class="title">
    <a href="/2021/03/16/go-web/">
      go_web
    </a>
  </h1>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="https://xaoxuu.com" target="_blank" rel="nofollow noopener">
    <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png">
    <p>Mr. X</p>
  </a>
</div>

            
          
            
              
  
  <div class='new-meta-item category'>
    <a href='/categories/go/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>go</p>
    </a>
  </div>


            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Mar 16, 2021</p>
  </a>
</div>

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <h2 id="1-概要"><a href="#1-概要" class="headerlink" title="1. 概要"></a>1. 概要</h2><p>处理请求</p>
<p>模版</p>
<p>中间件</p>
<p>存储数据</p>
<p>HTTPS，HTTP2</p>
<p>测试</p>
<p>部署</p>
<h2 id="2-处理请求"><a href="#2-处理请求" class="headerlink" title="2. 处理请求"></a>2. 处理请求</h2><h3 id="2-1-Create-pro"><a href="#2-1-Create-pro" class="headerlink" title="2.1 Create pro"></a>2.1 Create pro</h3><p>创建模块</p>
<p><code>GO111MODULE=on go mod init pro name</code> </p>
<p>helloworld</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		w.Write([]<span class="keyword">byte</span>(<span class="string">"hi go web"</span>))</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	http.ListenAndServe(<span class="string">"localhost:8999"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-如何处理web请求"><a href="#2-2-如何处理web请求" class="headerlink" title="2.2 如何处理web请求"></a>2.2 如何处理web请求</h3><p>http.Handle 函数</p>
<p>http.HandleFunc 函数</p>
<h4 id="2-2-1-创建web-Server"><a href="#2-2-1-创建web-Server" class="headerlink" title="2.2.1 创建web Server"></a>2.2.1 创建web Server</h4><p>两种方式</p>
<p>方式一</p>
<p>http.ListenAndServer()</p>
<p>http.ListenAndServeTLS()  https 服务</p>
<ul>
<li>第一个参数是网络地址，</li>
<li>第二个参数为handler<ul>
<li>如果为nil，那么就是DefaultServeMux</li>
</ul>
</li>
<li>DefaultServeMux 是一个multiplexer（可以看作是一个路由器）</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.ListenAndServe(<span class="string">"localhost:8989"</span>, <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>



<p>方式二</p>
<p>http.Server可配置</p>
<p>server.ListenAndServe()</p>
<p>server.ListenAndServeTLS()</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server:= http.Server &#123;</span><br><span class="line">	Addr: <span class="string">"localhost:8989"</span>,</span><br><span class="line">	Handler: <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">server.ListenAndServe()</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-DefaultServeMux"><a href="#2-2-2-DefaultServeMux" class="headerlink" title="2.2.2 DefaultServeMux"></a>2.2.2 DefaultServeMux</h4><p>它是一个multiplexer 多路复用器</p>
<p>它也是一个handler</p>
<p><img src="handler00.png" alt="image-20210317103838883"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> myHandler <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *myHandler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	w.Write([]<span class="keyword">byte</span>(<span class="string">"myHandler"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mu := myHandler&#123;&#125;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr: <span class="string">"localhost:8989"</span>,</span><br><span class="line">		Handler: &amp;mu,</span><br><span class="line">	&#125;</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>多个handler</p>
<p><img src="handler01.png" alt="image-20210317104736194"></p>
<p>不指定Server struct里面的Handler字段值</p>
<p>可以使用http.Handle将某个Handler附加到DefaultServeMux</p>
<ul>
<li>http包有一个Handle函数</li>
<li>ServerMux struct也有一个Handle方法</li>
</ul>
<p>如果你调用http.Handle，实际上调用的是DefaultServeMux上的Handle方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Handle</span><span class="params">(patten <span class="keyword">string</span>, handler Handler)</span> // 注册函数</span></span><br><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">	ServeHTTP(ResponseWriter, *Request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> myHandler <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *myHandler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	w.Write([]<span class="keyword">byte</span>(<span class="string">"myHandler"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> hiHandler <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *hiHandler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	w.Write([]<span class="keyword">byte</span>(<span class="string">"hello handler"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mu := myHandler&#123;&#125;</span><br><span class="line">	hi:= hiHandler&#123;&#125;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr: <span class="string">"localhost:8989"</span>,</span><br><span class="line">		Handler: <span class="literal">nil</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.Handle(<span class="string">"/mu"</span>, &amp;mu)</span><br><span class="line">	http.Handle(<span class="string">"/hi"</span>, &amp;hi)</span><br><span class="line"></span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-3-Handler-函数-http-HandleFunc"><a href="#2-2-3-Handler-函数-http-HandleFunc" class="headerlink" title="2.2.3 Handler 函数 - http.HandleFunc"></a>2.2.3 Handler 函数 - http.HandleFunc</h4><p>handler是一个接口（interface）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">	ServeHTTP(ResponseWriter, *Request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Handler函数就是那些行为与handler类似的函数：</p>
<p>Handler函数的签名与ServeHTTP方法的签名一样，接收：</p>
<ul>
<li>一个http.ResponseWriter</li>
<li>一个指向http.Request的指针</li>
</ul>
<p>Go有一个函数类型： HandlerFunc，可以将某个具有适当签名的函数f， 适配成为一个Handler，而这个Handler具有方法 f</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> myHandler <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *myHandler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	w.Write([]<span class="keyword">byte</span>(<span class="string">"myHandler"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> hiHandler <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *hiHandler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	w.Write([]<span class="keyword">byte</span>(<span class="string">"hello handler"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">welcome</span> <span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	w.Write([]<span class="keyword">byte</span>(<span class="string">"weclome"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mu := myHandler&#123;&#125;</span><br><span class="line">	hi:= hiHandler&#123;&#125;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr: <span class="string">"localhost:8989"</span>,</span><br><span class="line">		Handler: <span class="literal">nil</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.Handle(<span class="string">"/mu"</span>, &amp;mu)</span><br><span class="line">	http.Handle(<span class="string">"/hi"</span>, &amp;hi)</span><br><span class="line">	<span class="comment">//http.HandleFunc("/weclome", welcome)</span></span><br><span class="line">	http.Handle(<span class="string">"/wel"</span>, http.HandlerFunc(welcome)) <span class="comment">// handleFunc 函数内部有适配器 handlerFunc</span></span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>适配器HandlerFunc</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> HandlerFunc <span class="function"><span class="keyword">func</span><span class="params">(ResponseWriter, *Request)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ServeHTTP calls f(w, r).</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f HandlerFunc)</span> <span class="title">ServeHTTP</span><span class="params">(w ResponseWriter, r *Request)</span></span> &#123;</span><br><span class="line">	f(w, r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-4-五个内置handler"><a href="#2-2-4-五个内置handler" class="headerlink" title="2.2.4 五个内置handler"></a>2.2.4 五个内置handler</h4><p>NotFoundHandler 404</p>
<p>RedirectHandler  返回一个handler，把每个请求使用给定的状态吗跳转到指定的URl</p>
<ul>
<li>url，要跳转到的URL</li>
<li>code，跳转的状态吗（3XX），常见的 StatusMovedPermanently， StatusFound 或 StatusSeeOther</li>
</ul>
<p>StripPrefix 返回一个handler，它从请求URL中去掉指定的前缀，然后再调用另一个handler</p>
<p>TimeoutHandler</p>
<p>FileServer</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FileServer</span><span class="params">(root FileSystem)</span> <span class="title">Handler</span></span></span><br></pre></td></tr></table></figure>



<p>返回一个handler，使用基于root的文件系统来相应请求</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> FileSystem <span class="keyword">interface</span> &#123;</span><br><span class="line">	Open(name <span class="keyword">string</span>)(File, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用时需要用到操作系统的文件系统，所以还需要委托给操作系统的文件系统来获取文件；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Dir <span class="keyword">string</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d Dir)</span> <span class="title">Open</span><span class="params">(name <span class="keyword">string</span>)</span><span class="params">(File,error)</span></span></span><br></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//http.HandleFunc("/", func(writer http.ResponseWriter, request *http.Request) &#123;</span></span><br><span class="line">	<span class="comment">//	fmt.Printf(request.URL.Path)</span></span><br><span class="line">	<span class="comment">//	http.ServeFile(writer, request, "/webroot"+request.URL.Path)</span></span><br><span class="line">	<span class="comment">//&#125;)</span></span><br><span class="line">	<span class="comment">//http.ListenAndServe(":8000", nil)</span></span><br><span class="line">	http.ListenAndServe(<span class="string">":8000"</span>, http.FileServer(http.Dir(<span class="string">"webroot"</span>)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-5-Request"><a href="#2-2-5-Request" class="headerlink" title="2.2.5 Request"></a>2.2.5 Request</h4><p>HTTP请求</p>
<p>Request</p>
<p>URL</p>
<p>Header</p>
<p>Body</p>
<h5 id="2-2-5-1-HTTP消息"><a href="#2-2-5-1-HTTP消息" class="headerlink" title="2.2.5.1 HTTP消息"></a>2.2.5.1 HTTP消息</h5><p>HTTP Request 和 HTTP Response</p>
<p>它们具有相同的结构</p>
<ul>
<li>请求（响应）行</li>
<li>0个或多个Header</li>
<li>空行</li>
<li>可选的消息体（Body）</li>
</ul>
<p>net/http 包提供了用于表示HTTP消息的结构</p>
<p>Request（是个struct），代表了客户端发送的HTTP请求消息</p>
<p>Request（是个struct），代表了客户端发送的HTTP请求消息</p>
<p>重要字段：</p>
<ul>
<li>URL</li>
<li>Header</li>
<li>Body</li>
<li>Form，PostForm，MultipartForm</li>
</ul>
<p>也可以通过Request的方法访问请求中的Cookie、URL、User Agent等消息</p>
<p>Request即可代表发送到服务器的请求，又可代表客户端发出的请求；</p>
<h5 id="2-2-5-2-请求URL"><a href="#2-2-5-2-请求URL" class="headerlink" title="2.2.5.2 请求URL"></a>2.2.5.2 请求URL</h5><p>Request的URL字段就代表了请求行（请求信息第一行）里面的部分内容</p>
<p>URL字段是指向url.URL类型的一个指针，url.URL是一个struct：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> URL <span class="keyword">struct</span> &#123;</span><br><span class="line">  Scheme <span class="keyword">string</span></span><br><span class="line">  Opaque <span class="keyword">string</span></span><br><span class="line">  User *Userinfo</span><br><span class="line">  Host <span class="keyword">string</span></span><br><span class="line">  Path <span class="keyword">string</span></span><br><span class="line">  RawQuery <span class="keyword">string</span></span><br><span class="line">  Fragment <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>URL通用形式</p>
<p><code>scheme://[userinfo@]host/path[?query][#fragment]</code></p>
<p>不可以斜杠开头的URL被解释为：</p>
<p><code>scheme:opaque[?query][#fragment]</code></p>
<h5 id="2-2-5-3-URL-Query"><a href="#2-2-5-3-URL-Query" class="headerlink" title="2.2.5.3 URL Query"></a>2.2.5.3 URL Query</h5><p>RawQuery 会提供实际查询的字符串</p>
<p><code>http://www.example/com/post?id=123&amp;thread_id=456</code></p>
<ul>
<li>它的RawQuery的值就是id=123&amp;thread_id=456</li>
</ul>
<p>还有一个简便的方法可以得到Key-Value对： 通过Request的Form字段</p>
<h5 id="2-2-5-4-URL-Fragment"><a href="#2-2-5-4-URL-Fragment" class="headerlink" title="2.2.5.4 URL Fragment"></a>2.2.5.4 URL Fragment</h5><p>如果从浏览器发出的请求， 那么你无法提取出Fragment字段的值；</p>
<ul>
<li>浏览器在发送请求时会把fragment部分去掉</li>
</ul>
<p>但不是所有的请求都是从浏览器发出的（例如从HTTP客户端包）</p>
<h5 id="2-2-5-5-Request-Header"><a href="#2-2-5-5-Request-Header" class="headerlink" title="2.2.5.5 Request Header"></a>2.2.5.5 Request Header</h5><p>请求和响应（Request、Response）的headers是通过Header类型来描述的，它是一个map，用来表述HTTP Header里的 Key-Value对；</p>
<p>Header map的key是string类型，value是[]string</p>
<p>设置key的时候会创建一个空的[]string 作为value，value里面第一个元素就是新header的值；</p>
<p>为指定的key添加一个新的header值，执行append操作即可</p>
<p> res.Header</p>
<ul>
<li>返回map</li>
</ul>
<p>r.Header[“Accept-Encoding”]</p>
<ul>
<li>返回：<code>[gzip,deflate]([]string类型)</code></li>
</ul>
<p>r.Header.Get(“Accept-Encoding”)</p>
<ul>
<li>返回： gzip，deflate(string类型)</li>
</ul>
<h5 id="2-2-5-6-Request-Body"><a href="#2-2-5-6-Request-Body" class="headerlink" title="2.2.5.6 Request Body"></a>2.2.5.6 Request Body</h5><p>请求和响应的bodies都是使用Body字段来表示的</p>
<p>Body是一个io.ReadCloser接口</p>
<ul>
<li>一个是Reader接口</li>
<li>一个是Closer接口</li>
</ul>
<p>Reader接口定义了一个Open方法：</p>
<ul>
<li>参数： []byte</li>
<li>返回：byte的数量、可选的错误</li>
</ul>
<p>Closer接口定义了一个Close方法：</p>
<ul>
<li>没有参数，返回可选的错误；</li>
</ul>
<p>想要读取请求body的内容，可以调用Body的Read方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr: <span class="string">":8989"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">"/header"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		fmt.Fprintln(w, r.Header)</span><br><span class="line">		fmt.Fprintln(w, r.Header[<span class="string">"Accept-Encoding"</span>])</span><br><span class="line">		fmt.Fprintln(w, r.Header.Get(<span class="string">"Accept-Encoding"</span>))</span><br><span class="line">	&#125;)</span><br><span class="line">	http.HandleFunc(<span class="string">"/post"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		length := r.ContentLength</span><br><span class="line">		body := <span class="built_in">make</span>([]<span class="keyword">byte</span>, length) <span class="comment">// 创建一个长度为ContentLength的 byte slice</span></span><br><span class="line">		r.Body.Read(body) <span class="comment">// 将Body里面的内容，通过Read方法读取到body中</span></span><br><span class="line">		fmt.Fprintln(w, <span class="keyword">string</span>(body))</span><br><span class="line">	&#125;)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="2-2-5-7-查询参数（Query-Parameters）"><a href="#2-2-5-7-查询参数（Query-Parameters）" class="headerlink" title="2.2.5.7 查询参数（Query Parameters）"></a>2.2.5.7 查询参数（Query Parameters）</h5><p>URL Query</p>
<p><code>http://www/example.com/post?id=123&amp;thread_id=456</code></p>
<p>r.URL.RawQuery会提供实际查询的原始字符串</p>
<ul>
<li>上例的RawQuery的值就是 id=123&amp;thread_id=456</li>
</ul>
<p>r.URL.Query() 会提供查询字符串对应的 <code>map[string][]string</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">url := r.URL</span><br><span class="line">query := url.Query() <span class="comment">// map[string][]string</span></span><br><span class="line">id := query[<span class="string">"id"</span>] <span class="comment">// []string&#123;"123"&#125;</span></span><br><span class="line">threadID := query.Get(<span class="string">"thread_id"</span>) <span class="comment">// "456"</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-6-Form"><a href="#2-2-6-Form" class="headerlink" title="2.2.6 Form"></a>2.2.6 Form</h4><h5 id="2-2-6-1-通过表单发送请求"><a href="#2-2-6-1-通过表单发送请求" class="headerlink" title="2.2.6.1 通过表单发送请求"></a>2.2.6.1 通过表单发送请求</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/process"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"application/x-www-form-urlencoded"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"first_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"last_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个HTML表单里面的数据会以<code>name-value</code>对的形式，通过POST请求发送出去</p>
<p>它的数据内容会放在POST请求的Body里面</p>
<p>但name-value对在Body里面的格式是什么样的？</p>
<p><strong>表单Post请求的数据格式</strong></p>
<p>通过POST发送的name-value数据对的格式可以通过表单的Content Type来指定，也就是enctype属性</p>
<p><strong>表单的enctype属性</strong></p>
<p>默认值是：application/x-www-form-urlencoded</p>
<p>浏览器被要求至少要支持： application/x-www-form-urlencoded、multipart/form-data</p>
<ul>
<li>html5的话，还需要支持text/plain</li>
</ul>
<p>如果enctype是application/x-www-form-urlencoded，那么浏览器会将表单数据编码到查询字符串里面。</p>
<p><code>first_name=alex&amp;last_name=chang</code></p>
<p>如果enctype是multipart/form-data，那么</p>
<ul>
<li>每一个name-value对都会被转换为一个MIME消息部分</li>
<li>每一个部分都有自己的Content Type 和Content Disposition</li>
</ul>
<p><img src="content.png" alt="image-20210317170418395"></p>
<p><strong>如何选择？</strong></p>
<p>简单的文本：  application/x-www-form-urlencoded</p>
<p>大量数据，（文件上传）： multipart-MIME</p>
<ul>
<li>甚至可以把二进制数据通过选择Base64编码，来当作文本进行发送</li>
</ul>
<p><strong>表单的GET</strong></p>
<p>通过表单的method属性，可以设置POST还是GET</p>
<p>GET请求没有Body，所有的数据都通过URL的name-value对 来发送</p>
<h5 id="2-2-6-2-字段"><a href="#2-2-6-2-字段" class="headerlink" title="2.2.6.2 字段"></a>2.2.6.2 字段</h5><p>Request上的函数允许我们从URL或/和Body中提取数据，通过这些字段：Form，PostForm，MultipartForm</p>
<p>Form里面的数据是key-value对</p>
<p>通常的做法是：</p>
<ul>
<li>先调用ParseForm 或 ParseMultipartForm来解析Request</li>
<li>然后相应的访问Form、PostForm或MultipartForm字段</li>
</ul>
<p><strong>Form</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/process"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"application/x-www-form-urlencoded"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"first_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"last_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http.HandleFunc(<span class="string">"/process"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		r.ParseForm() <span class="comment">// 解析form</span></span><br><span class="line">		fmt.Fprintln(w, r.Form)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p><strong>PostForm</strong></p>
<p>上例中，如果只想得到first_name 这个key 的value，可使用r.Form[“first_name”],它返回含有一个元素的slice: [“Dave”]</p>
<p>如果表单和URL里有同样的Key，那么它们都会放在一个slice里：表单里的值靠前，URL的值靠后；</p>
<p>如果只想要表单的key-value对，不要URL的，可以使用PostForm字段；</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/process?first_name=Leo"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"application/x-www-form-urlencoded"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"first_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"last_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http.HandleFunc(<span class="string">"/process"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  r.ParseForm() <span class="comment">// 解析form</span></span><br><span class="line">  fmt.Fprintln(w, r.Form) </span><br><span class="line">  <span class="comment">// map[first_name:[alex Leo] last_name:[ruan]]</span></span><br><span class="line">  fmt.Fprintln(w, r.PostForm) </span><br><span class="line">  <span class="comment">// map[first_name:[alex] last_name:[ruan]]</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>PostForm只支持application/x-www-form-urlencoded，必须使用MultipartForm</p>
<p><strong>MultipartForm</strong></p>
<p>想要使用MultipartForm 这个字段，首先需要调用ParseMultipartForm这个方法；</p>
<ul>
<li>该方法会在必要时调用ParseForm方法</li>
<li>参数是需要读取数据的长度</li>
</ul>
<p>MultipartForm只包含表单的key-value对</p>
<p>返回的类型是一个struct而不是map，这个struct里有两个map：</p>
<ul>
<li>key是string，value是[]string</li>
<li>空的（key是string， value是文件）</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/process?first_name=Leo"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"first_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"last_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http.HandleFunc(<span class="string">"/process"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  r.ParseMultipartForm(<span class="number">1024</span>) <span class="comment">//1024 为字节数</span></span><br><span class="line">  fmt.Fprintln(w, r.MultipartForm)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// &amp;&#123;map[first_name:[alex] last_name:[ruan]] map[]&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>MultipartReader</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span><span class="title">MultipartReader</span><span class="params">()</span><span class="params">(*multipart.Reader,error)</span></span></span><br></pre></td></tr></table></figure>

<p>如果是multipart/form-data或multipart混合的POST请求：</p>
<ul>
<li>MultipartReader 返回一个MIME multipart reader</li>
<li>否则返回nil和一个错误</li>
</ul>
<p>可以使用该函数代替ParseMultipartForm来把请求的body作为stream进行处理</p>
<ul>
<li>不是把表单作为一个对象来处理的，不是一次性获得整个map</li>
</ul>
<p>逐个检查来自表单的值，然后每次处理一个；</p>
<h5 id="2-2-6-3-FormValue-amp-PostFormValue方法"><a href="#2-2-6-3-FormValue-amp-PostFormValue方法" class="headerlink" title="2.2.6.3 FormValue &amp; PostFormValue方法"></a>2.2.6.3 FormValue &amp; PostFormValue方法</h5><p>FormValue方法会返回Form字段中指定key对应的第一个value</p>
<ul>
<li>无需调用ParseForm或ParseMultipartForm</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://localhost:8000/process?first_name=Leo"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"first_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"last_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http.HandleFunc(<span class="string">"/process"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  fmt.Fprintln(w, r.FormValue(<span class="string">"first_name"</span>))</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// Leo  来自于查询字符串，来自表单里面的值靠前，来自url的靠后，FormValue只取一个值（如果enctype为application/x-www-form-urlencoded的话）；</span></span><br></pre></td></tr></table></figure>

<p>PostFormValue方法也一样，但只能读取PostForm</p>
<p>FormValue和PostFormValue都会调用ParseMultipartForm方法</p>
<p>但如果表单的enctype设为multipart/form-data，那么即使你调用ParseMultipartForm方法，也无法通过FormValue获得想要的值；</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://localhost:8000/process?first_name=Leo"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"first_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"last_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http.HandleFunc(<span class="string">"/process"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  r.ParseMultipartForm(<span class="number">1024</span>) <span class="comment">//1024 为字节数</span></span><br><span class="line">  fmt.Fprintln(w, r.FormValue(<span class="string">"first_name"</span>))</span><br><span class="line">  fmt.Fprintln(w,r.PostFormValue(<span class="string">"first_name"</span>))</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// Leo</span></span><br><span class="line"><span class="comment">// alex</span></span><br></pre></td></tr></table></figure>



<h5 id="2-2-6-4-上传文件（Files）"><a href="#2-2-6-4-上传文件（Files）" class="headerlink" title="2.2.6.4 上传文件（Files）"></a>2.2.6.4 上传文件（Files）</h5><p>Multipart/form-data最常见的应用场景就是上传文件（例子）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://localhost:8000/process?first_name=Leo"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"first_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"last_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	r.ParseMultipartForm(<span class="number">1024</span>)</span><br><span class="line">	fileHeader:= r.MultipartForm.File[<span class="string">"uploaded"</span>][<span class="number">0</span>]</span><br><span class="line">	file,err := fileHeader.Open() <span class="comment">// 从File字段 获得的FileHeader，调用其Open获得文件。</span></span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		data, err := ioutil.ReadAll(file) <span class="comment">// 读取文件内容到byte切片里</span></span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Fprintln(w, <span class="keyword">string</span>(data))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr: <span class="string">":8000"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		fmt.Printf(request.URL.Path)</span><br><span class="line">		http.ServeFile(writer, request, <span class="string">"webroot2"</span>+request.URL.Path)</span><br><span class="line">	&#125;)</span><br><span class="line">	http.HandleFunc(<span class="string">"/process"</span>, process)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FormFile方法</p>
<ul>
<li>上传文件还有一个简便方法：FormFile</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>&#123;</span><br><span class="line">  file,_,err := r.FormFile(<span class="string">"uploaded"</span>)</span><br><span class="line">  <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">    data, err := ioutil.ReadAll(file)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Fprintln(w, <span class="keyword">string</span>(data))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>无需调用ParseMultipartForm方法</p>
<p>返回指定key对应的第一个value</p>
<p>同时返回File和FileHeader，以及错误信息</p>
<p>如果只上传一个文件，那么这种方式会快一些</p>
<h5 id="2-2-6-5-POST-JSON"><a href="#2-2-6-5-POST-JSON" class="headerlink" title="2.2.6.5 POST JSON"></a>2.2.6.5 POST JSON</h5><p>不是所有的POST请求都来自Form</p>
<p>有很多不同的方式对POST请求编码</p>
<ul>
<li>application/x-www-form-urlencoded</li>
<li>application/json</li>
</ul>
<p>ParseForm方法无法处理application/json</p>
<h4 id="2-2-7-ResponseWriter"><a href="#2-2-7-ResponseWriter" class="headerlink" title="2.2.7 ResponseWriter"></a>2.2.7 ResponseWriter</h4><p>从服务器向客户端返回响应需要使用ResponseWriter</p>
<p>ResponseWriter是一个接口，handler用它来返回响应</p>
<p>真正支撑ResponseWriter的幕后struct是非导出的http.response</p>
<p>问题：</p>
<p>为什么Handler的ServeHTTP（w ResponseWriter, r*Request）,只有一个是指针类型？而w是按值传递的吗？</p>
<p>ResponseWriter本身是一个interface，而它代表了一个指针，这个指针指向response这个struct的。所以它也可以看作是一个指针。所以它的传递也是按引用进行传递的；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ResponseWriter <span class="keyword">interface</span> &#123;</span><br><span class="line">  Header() Header</span><br><span class="line">  Write([]<span class="keyword">byte</span>)(<span class="keyword">int</span> error)</span><br><span class="line">  WriteHeader(statusCode <span class="keyword">int</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> response <span class="keyword">struct</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *response)</span> <span class="title">Header</span><span class="params">()</span><span class="title">Header</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *response)</span> <span class="title">Write</span><span class="params">()</span><span class="title">Writer</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *response)</span> <span class="title">WriteHeader</span><span class="params">()</span><span class="title">WriteHeader</span></span></span><br><span class="line"><span class="comment">// 所以说 response指针就是实现了ResponseWriter接口，所以ResponseWriter接口就代表着 response指针；</span></span><br></pre></td></tr></table></figure>

<h5 id="2-2-7-1-写入到ResponseWriter"><a href="#2-2-7-1-写入到ResponseWriter" class="headerlink" title="2.2.7.1 写入到ResponseWriter"></a>2.2.7.1 写入到ResponseWriter</h5><p>write方法接收一个byte切片作为参数，然后把它写入到HTTP响应的Body里面；</p>
<p>如果在Write方法被调用时，header里面没有设定content type，那么数据的前512字节就会被用来检测content type</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeExample</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	str := <span class="string">`&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;&lt;title&gt;&lt;go web&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;&lt;h1&gt;hello go&lt;/h1&gt;&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;`</span></span><br><span class="line">w.Write([]<span class="keyword">byte</span>(str))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr: <span class="string">":8000"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">"/write"</span>, writeExample)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i localhost:8000/write</span><br></pre></td></tr></table></figure>

<h5 id="2-2-7-2-WriteHeader方法"><a href="#2-2-7-2-WriteHeader方法" class="headerlink" title="2.2.7.2 WriteHeader方法"></a>2.2.7.2 WriteHeader方法</h5><p>WriteHeader方法接收一个整数类型（HTTP状态码）作为参数，并把它作为HTTP响应的状态码返回</p>
<p>如果该方法没有显式调用，那么在第一次调用Write方法前，会隐式的调用WriteHeader(http.StatusOK)</p>
<ul>
<li>所以WriteHeader主要用来发送错误类的HTTP状态吗</li>
</ul>
<p>调用完WriteHeader方法之后，仍然可以写入到ResponseWriter，但无法再修改header了；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeExample</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	str := <span class="string">`&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;&lt;title&gt;go cProgramming&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;&lt;h1&gt;hello go&lt;/h1&gt;&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;`</span></span><br><span class="line">w.Write([]<span class="keyword">byte</span>(str))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeHeaderExample</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>&#123;</span><br><span class="line">	w.WriteHeader(<span class="number">501</span>)</span><br><span class="line">	fmt.Fprintln(w, <span class="string">"No such service, try next port"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr: <span class="string">":8000"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">"/write"</span>, writeExample)</span><br><span class="line">	http.HandleFunc(<span class="string">"/writeheader"</span>, writeHeaderExample)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-2-7-3-Header方法"><a href="#2-2-7-3-Header方法" class="headerlink" title="2.2.7.3 Header方法"></a>2.2.7.3 Header方法</h5><p>Header方法返回headers的map，可以进行修改</p>
<p>修改后的headers将会体现在返回给客户端的HTTP响应里；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">headerExample</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>&#123;</span><br><span class="line">	w.Header().Set(<span class="string">"Location"</span>,<span class="string">"https://reactnative.dev/"</span>)</span><br><span class="line">	w.WriteHeader(<span class="number">302</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="red.png" alt="image-20210317232645674"></p>
<p>json</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">jsonExample</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>&#123;</span><br><span class="line">	w.Header().Set(<span class="string">"Content-Type"</span>,<span class="string">"application/json"</span>)</span><br><span class="line">	post:= &amp;Post&#123;</span><br><span class="line">		User: <span class="string">"alex"</span>,</span><br><span class="line">		Threads: []<span class="keyword">string</span>&#123;<span class="string">"first"</span>,<span class="string">"second"</span>,<span class="string">"third"</span>&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	json,_ := json2.Marshal(post)</span><br><span class="line">	w.Write(json)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// &#123;"User":"alex","Threads":["first","second","third"]&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-2-7-4-内置的Response"><a href="#2-2-7-4-内置的Response" class="headerlink" title="2.2.7.4 内置的Response"></a>2.2.7.4 内置的Response</h5><p>NotFound函数，包装一个404状态吗和一个额外的信息</p>
<p>ServeFile函数，从文件系统提供文件，返回请求者</p>
<p>ServerContent函数，它可以把实现了io.ReadSeeker接口的任何东西里面的内容返回给请求者</p>
<ul>
<li>还可以处理Range请求（范围请求），如果只请求了资源的一部分内容，那么ServeContent就可以如此响应，而ServeFile或io.Copy则不行</li>
</ul>
<p>Redirect函数，告诉客户端重定向到另一个URL</p>
<h2 id="3-connect-sql"><a href="#3-connect-sql" class="headerlink" title="3.connect sql"></a>3.connect sql</h2><h3 id="3-1-Open"><a href="#3-1-Open" class="headerlink" title="3.1 Open"></a>3.1 Open</h3><p>sql.Open()</p>
<ul>
<li>参数1 数据库驱动名称</li>
<li>参数2 数据源名称</li>
<li>返回值 得到一个指向sql.DB这个struct的指针</li>
</ul>
<p>sql.DB是用来操作数据库的，它代表了0个或者多个底层连接的池，这些连接由sql包来维护，sql包会自动的创建和释放这些连接；</p>
<p>它对于多个goroutine并发的使用是安全的；</p>
<p>Open()函数并不会连接数据库，甚至不回验证其参数，它只是把后续连接到数据库所必需的structs给设置好了；</p>
<p>而真正的连接是在被需要的时候才进行懒设置的；</p>
<p>sql.DB不需要进行关闭（当然你想关闭也是可以的）</p>
<p>它就是用来处理数据库的，而不是实际的连接</p>
<p>这个抽象包含了数据库连接的池，而且会对此进行维护</p>
<p>在使用sql.DB的时候，可以定义它的全局变量进行使用，也可以将它传递函数/方法里；</p>
<h3 id="3-2-如何获得驱动"><a href="#3-2-如何获得驱动" class="headerlink" title="3.2 如何获得驱动"></a>3.2 如何获得驱动</h3><p>正常的做法是使用sql.Register()函数、数据库驱动的名称和一个实现了driver.Driver接口的struct，来注册数据库的驱动。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql.Register(<span class="string">"sqlserver"</span>, &amp;drv&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>但是之前的例子却没有写这句话，为什么？</p>
<ul>
<li>因为Sql Server的驱动，是在这个包被引入的时候进行了自我注册</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	_ <span class="string">"github.com/go-sql-driver/mysql"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>当go-sql-driver包被引入的时候，它的init函数将会运行并进行自我注册（在Go语言里，每个包的init函数都会在自动的调用）</p>
<p>在引入go-sql-driver 包的时候，把该包的名称设置为下划线_，这是因为我们不直接使用数据库驱动（只需要它起的“副作用”），我们只使用database/sql</p>
<p>这样，如果未来升级驱动，也无需改变代码</p>
<p>Go语言没有提供官方的数据库驱动，所有的数据库驱动都是第三方驱动，但是它们都遵循sql.driver包里面定义的接口</p>
<h3 id="3-3-下载驱动"><a href="#3-3-下载驱动" class="headerlink" title="3.3 下载驱动"></a>3.3 下载驱动</h3><p><code>go get github.com/go-sql-driver/mysql</code></p>
<h3 id="3-4-PingContext"><a href="#3-4-PingContext" class="headerlink" title="3.4 PingContext"></a>3.4 PingContext</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*DB)</span> <span class="title">PingContext</span></span></span><br></pre></td></tr></table></figure>

<p>db.PingContext 函数是用来验证与数据库的连接是否仍然有效，如有必要则建立一个连接</p>
<p>这个函数需要一个Context（上下文）类型的参数，这种类型可以携带截止时间，取消信息和其它请求范围的值，并且可以横跨API边界和进程。</p>
<p>上例中，创建context使用的是context.Background()函数，该函数返回一个非nil的空Context，它不会被取消，它没有值，没有截止时间；</p>
<p>它通常在main函数，初始化或测试中，作为传入请求的顶级Context</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ctx := context.Background()</span><br><span class="line">err = db.PingContext(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  log.Fatalln(err.Error())</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"Connected"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-5-查询"><a href="#3-5-查询" class="headerlink" title="3.5 查询"></a>3.5 查询</h3><p>sql.DB类型上用于查询的方法有：</p>
<ul>
<li>Query</li>
<li>QueryRow （返回一行）</li>
<li>QueryContext</li>
<li>QueryRowContext</li>
</ul>
<h4 id="3-5-1-Query"><a href="#3-5-1-Query" class="headerlink" title="3.5.1 Query"></a>3.5.1 Query</h4><p>返回的类型是 type Rows struct{}</p>
<p>Rows的方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rs *Rows)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span></span><br><span class="line"><span class="comment">// 返回结果的列的信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rs *Rows)</span> <span class="title">ColumnTypes</span><span class="params">()</span><span class="params">([]*ColumnType, error)</span></span></span><br><span class="line"><span class="comment">// 返回所有列名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rs *Rows)</span> <span class="title">Columns</span><span class="params">()</span><span class="params">([]<span class="keyword">string</span>, error)</span></span></span><br><span class="line"><span class="comment">// 查询遍历中的错误</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rs *Rows)</span> <span class="title">Err</span><span class="params">()</span> <span class="title">error</span></span></span><br><span class="line"><span class="comment">// 遍历结果集，每次读取一行，返回true说明还有数据 false表示读到最后一行了</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rs *Rows)</span> <span class="title">Next</span><span class="params">()</span> <span class="title">bool</span></span></span><br><span class="line"><span class="comment">// 如果查询包含多个结果集，使用NextResultSet。它会准备好下一个结果集用来读取。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rs *Rows)</span> <span class="title">NextResultSet</span><span class="params">()</span> <span class="title">bool</span></span></span><br><span class="line"><span class="comment">// 把当前行的数据拷贝出来，然后放置到 参数中的变量里面；</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rs *Rows)</span> <span class="title">Scan</span><span class="params">(dest...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span></span><br></pre></td></tr></table></figure>



<h4 id="3-5-2-QueryRow"><a href="#3-5-2-QueryRow" class="headerlink" title="3.5.2 QueryRow"></a>3.5.2 QueryRow</h4><p>返回类型是 type Row struct{}</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询遍历中的错误</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rs *Rows)</span> <span class="title">Err</span><span class="params">()</span> <span class="title">error</span></span></span><br><span class="line"><span class="comment">// 把当前行的数据拷贝出来，然后放置到 参数中的变量里面；</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rs *Row)</span> <span class="title">Scan</span><span class="params">(dest...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span></span><br></pre></td></tr></table></figure>



<h3 id="3-6-更新"><a href="#3-6-更新" class="headerlink" title="3.6 更新"></a>3.6 更新</h3><p>sql.DB类型上用于更新（执行命令）的方法有：</p>
<p>Exec</p>
<p>ExecContext</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a * app)</span><span class="title">Update</span><span class="params">()</span><span class="params">(err error)</span></span> &#123;</span><br><span class="line">  _,err := db.Exc(<span class="string">"sql 语句"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-7-其它"><a href="#3-7-其它" class="headerlink" title="3.7 其它"></a>3.7 其它</h3><p>Ping</p>
<p>PingContext</p>
<p>Prepare</p>
<p>PrepareContext</p>
<p>Transactions</p>
<ul>
<li>Begin</li>
<li>BeginTx</li>
</ul>
<h2 id="4-路由"><a href="#4-路由" class="headerlink" title="4. 路由"></a>4. 路由</h2><p>需要给架构增加Controller层</p>
<p>Controller的角色</p>
<ul>
<li>main(): 设置类工作，比如设置http server</li>
<li>Controller:<ul>
<li>静态资源 （比如css，js文件）</li>
<li>把不同的请求送到不同的controller进行处理</li>
</ul>
</li>
</ul>
<p><img src="ctrl.png" alt="image-20210318180336477"></p>
<p>go语言提供一个前置的ctrl，所有进来的请求都会经过ctrl，然后由ctrl分发</p>
<h2 id="5-json"><a href="#5-json" class="headerlink" title="5. json"></a>5. json</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Post <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID      <span class="keyword">int</span> <span class="string">`json:"id"`</span></span><br><span class="line">	User 	<span class="keyword">string</span> <span class="string">`json:"user"`</span></span><br><span class="line">	Threads []<span class="keyword">string</span> <span class="string">`json:"thread"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-1-类型映射"><a href="#5-1-类型映射" class="headerlink" title="5.1 类型映射"></a>5.1 类型映射</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Go <span class="keyword">bool</span>: JSON boolean</span><br><span class="line">Go <span class="keyword">float64</span>: JSON 数值</span><br><span class="line">Go <span class="keyword">string</span>; JSON strings</span><br><span class="line">Go <span class="literal">nil</span>: JSON null</span><br></pre></td></tr></table></figure>



<h3 id="5-2-未知结构的JSON如何映射"><a href="#5-2-未知结构的JSON如何映射" class="headerlink" title="5.2 未知结构的JSON如何映射"></a>5.2 未知结构的JSON如何映射</h3><p>Map[string]interface{} 可以存储任意json对象</p>
<p>[]interface{} 可以存储任意的JSON数组</p>
<h3 id="5-3-读取JSON"><a href="#5-3-读取JSON" class="headerlink" title="5.3 读取JSON"></a>5.3 读取JSON</h3><p>需要一个解码器： </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dec := json.NewDecoder(r.Body)</span><br></pre></td></tr></table></figure>

<p>参数需要实现Reader接口</p>
<p>在解码器上进行编码： dec.Decode(&amp;query)</p>
<h3 id="5-4-写入JSON"><a href="#5-4-写入JSON" class="headerlink" title="5.4 写入JSON"></a>5.4 写入JSON</h3><p>需要一个编码器</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">enc := json.NewEncoder(w)</span><br></pre></td></tr></table></figure>

<p>参数需要实现Writer接口</p>
<p>编码 ： enc.Encode(results)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">json</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> r.Method &#123;</span><br><span class="line">	<span class="keyword">case</span> http.MethodPost:</span><br><span class="line">		dec := json2.NewDecoder(r.Body)</span><br><span class="line">		company := Company&#123;&#125;</span><br><span class="line">		err:= dec.Decode(&amp;company)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err.Error())</span><br><span class="line">			w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		enc := json2.NewEncoder(w)</span><br><span class="line">		err = enc.Encode(company)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err.Error())</span><br><span class="line">			w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		w.WriteHeader(http.StatusMethodNotAllowed)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Marshal 和 Unmarshal</strong></p>
<p>Marshal （编码）： 把go struct转化为json格式</p>
<ul>
<li>Marshalindent, 带缩进</li>
</ul>
<p>Unmarshal（解码）： 把json转化为go struct</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Company <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID      <span class="keyword">int</span> <span class="string">`json:"id"`</span></span><br><span class="line">	User 	<span class="keyword">string</span> <span class="string">`json:"user"`</span></span><br><span class="line">	Threads []<span class="keyword">string</span> <span class="string">`json:"thread"`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  </span><br><span class="line">  jsonStr := <span class="string">`&#123;</span></span><br><span class="line"><span class="string">		"id": 123,</span></span><br><span class="line"><span class="string">		"name": "alex",</span></span><br><span class="line"><span class="string">		"thread": "asia"</span></span><br><span class="line"><span class="string">	&#125;`</span></span><br><span class="line">	c:= Company&#123;&#125;</span><br><span class="line">	_ = json2.Unmarshal([]<span class="keyword">byte</span>(jsonStr), &amp;c)</span><br><span class="line">	fmt.Println(c)</span><br><span class="line"></span><br><span class="line">	bytes,_ := json2.Marshal(c)</span><br><span class="line">	fmt.Println(<span class="keyword">string</span>(bytes))</span><br><span class="line"></span><br><span class="line">	bytes1, _ := json2.MarshalIndent(c,<span class="string">""</span>,<span class="string">"  "</span>)</span><br><span class="line">	fmt.Println(<span class="keyword">string</span>(bytes1))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#123;123 alex [asia]&#125;</span></span><br><span class="line"><span class="comment">//&#123;"id":123,"user":"alex","thread":["asia"]&#125;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"id"</span>: <span class="number">123</span>,</span><br><span class="line">  <span class="string">"user"</span>: <span class="string">"alex"</span>,</span><br><span class="line">  <span class="string">"thread"</span>: [</span><br><span class="line">    <span class="string">"asia"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>两种方式的区别</strong></p>
<p>针对string或bytes：</p>
<ul>
<li>Marshal =&gt; string</li>
<li>Unmarshal &lt;= string</li>
</ul>
<p>针对stream：</p>
<ul>
<li>Encode =&gt; Stream, 把数据写入到 io.Writer</li>
<li>Decode &lt;= Stream, 从io.Reader 读取数据</li>
</ul>
<h2 id="6-中间件"><a href="#6-中间件" class="headerlink" title="6. 中间件"></a>6. 中间件</h2><p><img src="middleware.png" alt="image-20210319133248463"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http.ListenAndServe(addr <span class="keyword">string</span>, handler Handler)error</span><br><span class="line"><span class="comment">// handler 如果是nil： DefaultServeMux</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 想创建handler，必须实现handler接口，需要实现ServeHTTP这个方法</span></span><br><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">	ServeHTTP(ResponseWriter, *Request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-1-创建中间件"><a href="#6-1-创建中间件" class="headerlink" title="6.1 创建中间件"></a>6.1 创建中间件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MyMiddleware <span class="keyword">struct</span> &#123;</span><br><span class="line">  Next http.Handler</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m MyMiddleware)</span> <span class="title">ServeHTTP</span> <span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  <span class="comment">// 在next handler之前做一些事情</span></span><br><span class="line">  m.Next.ServeHTTP(w, r) <span class="comment">// 将该请求转发到下一个handler中</span></span><br><span class="line">  <span class="comment">// 在 next handler之后做一些其它事情（对响应进行处理，中间件中创建的资源进行处理，此时响应仍然是没有返回至客户端的）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>m.Next.ServeHTTP(w, r) 将该请求转发到下一个handler中。至于下一个handler是什么，这个Next设置成什么，下一个handler就是什么，有可能是nil。在web应用中，如果只有一个中间件的话。那么next就是DefaultServeMux。它就会将这个请求 进行路由。然后进程的处理。</p>
<p>中间件的用途</p>
<p>Logging</p>
<p>安全（请求超时，用户身份认证）</p>
<p>响应压缩</p>
<h3 id="6-2-使用请求上下文"><a href="#6-2-使用请求上下文" class="headerlink" title="6.2 使用请求上下文"></a>6.2 使用请求上下文</h3><p><img src="ctx.png" alt="image-20210319144135404"></p>
<p>比如中间件设置了请求超时，而这个请求到数据库的时候，这个数据库将会花费很长时间。这个时候就需要让访问数据库的代码知道设置了查询超时时间。这就需要使用到上下文来解决；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*Request)</span> <span class="title">Context</span><span class="params">()</span> <span class="title">context</span>.<span class="title">Context</span></span></span><br><span class="line"><span class="comment">// 返回当前请求的上下文</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*Request)</span> <span class="title">WithContext</span><span class="params">(ctx context.Context)</span><span class="title">context</span>.<span class="title">Context</span></span></span><br><span class="line"><span class="comment">// 基于Context 进行 修改，（实际上）创建一个新的Context</span></span><br></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">	Deadline() (deadline time.Time, ok <span class="keyword">bool</span>)</span><br><span class="line">  <span class="comment">// 返回一个channel，用来做取消操作的。一旦context取消了。它就会接收到一个信号。这个channel也就关闭了；。比如在操作截止时间就会接到这个信号</span></span><br><span class="line">  Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; <span class="comment">// 取消操作</span></span><br><span class="line">  <span class="comment">// 如果 Done 这个channel没有关闭的话，error就是nil，如果它关闭了，也就是context被取消了。那么error就存放被取消的原因；以后每次调用error都会显示同一个错误；</span></span><br><span class="line">  Err()error</span><br><span class="line">  <span class="comment">// 使用参数key从context获取一些信息，得到的这些信息可以从架构中的一个层传给另一个层；</span></span><br><span class="line">  Value(key <span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些方法都是用于读取，不能进行设置；</p>
<p>Context API - 可以返回新Context</p>
<ul>
<li>WithCancal() ,它有一个CancelFunc</li>
<li>WithDeadline(), 带有一个时间戳 （time.Time）</li>
<li>WithTimeout(), 带有一个具体的时间段（time.Duration）</li>
<li>WithValue(), 在里面可以添加一些值；</li>
</ul>
<h2 id="7-HTTPS"><a href="#7-HTTPS" class="headerlink" title="7. HTTPS"></a>7. HTTPS</h2><p>HTTP请求的过程</p>
<p><img src="http.png" alt="image-20210319155909596"></p>
<p>在http里面，参数都是以明文进行传输的。在客户端和服务端之间其它的东西，比如某个中间人/中间服务器也能懂得传输的信息。所以说，这种传输是非常不安全的 ；</p>
<p>HTTPS</p>
<p>https会稍微给传输层做一点改变，它不是直接在TCP上面传输数据的。会添加一个TLS层，在传输数据的时候，数据首先会被加密。加密之后只有客户端和服务器能够懂得这个加密数据里面真实的内容。中间人/中间服务器即使能获得数据，但是依然无法解析出来内容；也就无法懂得它真正代表的意思了；</p>
<h3 id="7-1-HTTP-ListenAndServeTLS"><a href="#7-1-HTTP-ListenAndServeTLS" class="headerlink" title="7.1 HTTP.ListenAndServeTLS"></a>7.1 HTTP.ListenAndServeTLS</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ListenAndServeTLS 四个参数</span></span><br><span class="line">addr</span><br><span class="line">certFile</span><br><span class="line">keyFile</span><br><span class="line">handler</span><br><span class="line">http.ListenAndServeTLS()</span><br></pre></td></tr></table></figure>

<p>go 提供了生成证书的方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">go run /usr/<span class="built_in">local</span>/go/src/crypto/tls/generate_cert.go -h</span><br><span class="line"></span><br><span class="line">go run /usr/<span class="built_in">local</span>/go/src/crypto/tls/generate_cert.go -host localhost</span><br><span class="line"></span><br><span class="line"><span class="comment"># time  wrote cert.pem</span></span><br><span class="line"><span class="comment"># time  wrote key.pem</span></span><br><span class="line"></span><br><span class="line">http.ListenAndServeTLS(<span class="string">":8080"</span>, <span class="string">"cert.pem"</span>, <span class="string">"key.pem"</span>, nil)</span><br></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Request Headers</span><br><span class="line">  :authority: localhost:8080</span><br><span class="line">  :method: GET</span><br><span class="line">  :path: /json</span><br><span class="line">  :scheme: https</span><br><span class="line">  accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">  accept-encoding: gzip, deflate, br</span><br><span class="line">  accept-language: zh-CN,zh;q=0.9</span><br><span class="line">  cache-control: no-cache</span><br><span class="line">  cookie: </span><br><span class="line">  pragma: no-cache</span><br><span class="line">  sec-ch-ua: "Google Chrome";v="89", "Chromium";v="89", ";Not A Brand";v="99"</span><br><span class="line">  sec-ch-ua-mobile: ?0</span><br><span class="line">  sec-fetch-dest: document</span><br><span class="line">  sec-fetch-mode: navigate</span><br><span class="line">  sec-fetch-site: none</span><br><span class="line">  sec-fetch-user: ?1</span><br><span class="line">  upgrade-insecure-requests: 1</span><br><span class="line">  user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 11_2_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36</span><br></pre></td></tr></table></figure>

<p>Headers 以：开头，在go web应用里面，如果从http转到https，那么此应用会自动从http1.1 升级到http2协议。</p>
<h2 id="8-HTTP-2"><a href="#8-HTTP-2" class="headerlink" title="8. HTTP/2"></a>8. HTTP/2</h2><p>http2带来效率提升的原因</p>
<p>Http1.1发送请求</p>
<ol>
<li>首先建立tcp连接</li>
<li>发送请求时，通常header 和 body捆绑在一起发送的。尽管有时候body比较大，会被分到不同的包中发送。</li>
<li>响应返回的时候，基本和请求类似，也是header和body捆绑发送；</li>
</ol>
<p>这就导致header无法被压缩，header描述了请求或者响应里面的内容比如content-type，length等等，有些时候header比较大。</p>
<p>HTTP2</p>
<ol>
<li>依旧建立TCP服务</li>
<li>在TCP里建立stream，stream是在TCP里面独立通信的管道。各个stream不会相互影响。但是允许在同一个链接里面让多个信息来回发送但不相互干扰。在stream里面是通过Frame来发送消息的；所以它在发送请求的时候，不是将header和body绑在一起发送；而是将消息拆成多个Frame进行发送的；而每个Frame又可以单独的进行优化；</li>
</ol>
<p>有哪些Frame</p>
<p><img src="http2.png" alt="image-20210319172332556"></p>
<p>客户端往服务端发送header的时候，服务器知道它将接收到header。这个过程就能使用到一些压缩算法。</p>
<h3 id="8-1-http2的特点"><a href="#8-1-http2的特点" class="headerlink" title="8.1 http2的特点"></a>8.1 http2的特点</h3><ul>
<li>请求多路复用，可以在同一个TCP连接使用stream发送多个请求；</li>
<li>Header压缩</li>
<li>默认安全<ul>
<li>HTTP， 但很多决定不支持HTTP</li>
<li>HTTPS</li>
</ul>
</li>
<li>Server Push</li>
</ul>
<p><strong>没有Server push</strong></p>
<p><img src="noserverpush.png" alt="image-20210319172951647"></p>
<p>没有Server push的时候，请求是一来一回的。</p>
<p><strong>server push</strong></p>
<p><img src="serverpush.png" alt="image-20210319173601377"></p>
<p>节省了一个步骤，从客户端往服务端请求app.css的部分；</p>
<h2 id="9-部署"><a href="#9-部署" class="headerlink" title="9. 部署"></a>9. 部署</h2><p>Nohup</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./it &amp;</span><br></pre></td></tr></table></figure>



<p>守护进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&gt; vim /etc/systemd/system/go-web.service</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Go web App running on xxx</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/home/solenovex/it/it</span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line">RestartSec=10</span><br><span class="line">KillSignal=SINGINT</span><br><span class="line">SyslogIdentifier=go-web-example</span><br><span class="line">User=solenovex</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start go-web.service</span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">sudo systemctl status go-web.service</span><br></pre></td></tr></table></figure>



<h2 id="10-IM项目"><a href="#10-IM项目" class="headerlink" title="10 IM项目"></a>10 IM项目</h2><h3 id="10-1-构建基础server"><a href="#10-1-构建基础server" class="headerlink" title="10.1 构建基础server"></a>10.1 构建基础server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建</span></span><br><span class="line">go build -o server main.go server.go</span><br><span class="line">./server</span><br><span class="line">$&gt; connect success</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line">nc 127.0.0.1 8888</span><br></pre></td></tr></table></figure>



<h3 id="10-2-用户上线功能"><a href="#10-2-用户上线功能" class="headerlink" title="10.2 用户上线功能"></a>10.2 用户上线功能</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要给server补充两个属性, OnlineMap 和 channel</span></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span> &#123;</span><br><span class="line">	Ip   <span class="keyword">string</span></span><br><span class="line">	Port <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/Users/ruanhan/hexoblog/rh/source/_posts/go-web/user.png" alt="image-20210323180444298"></p>
<p><strong>OnlineMap</strong></p>
<p>key： 当前用户名</p>
<table>
<thead>
<tr>
<th>user.Name</th>
<th>User</th>
</tr>
</thead>
<tbody><tr>
<td>Name1</td>
<td>User1</td>
</tr>
<tr>
<td>Name2</td>
<td>User2</td>
</tr>
<tr>
<td>Name3</td>
<td>user3</td>
</tr>
</tbody></table>
<p>记录当前有哪些用户在线，一个客户端就是一个用户；</p>
<p>用一个User类来表示客户端</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User &#123;</span><br><span class="line">  username</span><br><span class="line">  conn <span class="comment">// 可以跟客户端进行通信</span></span><br><span class="line">  channel <span class="comment">// 每个用户都绑定一个channel，专门用来向user实例对应的客户端来发消息的；</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>channel</strong></p>
<p>每个用户都绑定一个channel，专门用来向user实例对应的客户端来发送消息。比如服务器往客户端1发送消息时，服务器就应该将消息发给User1.channel。channel又该如何将消息发送给客户端呢？</p>
<p>每个User实例中都会有一个goroutine，此goroutine应该阻塞监听channel，查看它当中是否有数据存在。一旦监听到数据，立即将数据通过conn写到对应的客户端中；</p>
<p><strong>Message</strong></p>
<p>message本质上是个channel，它属于server的channel。Message是用来将消息进行广播的。（如果当前有一条消息需要让所有客户端都收听到的话）</p>
<p>如何广播？</p>
<p>将消息发送到Message的管道中，Message中除了有管道，还需要有一个goroutine。不断在监听当前管道。一旦监听到有消息时，遍历OnlineMap依次将消息发送给每个的user的channel中；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server</span></span><br><span class="line">$&gt; ./server</span><br><span class="line"><span class="comment"># client1</span></span><br><span class="line">$&gt; nc 127.0.0.1 8888</span><br><span class="line">$&gt;[127.0.0.1:51375]127.0.0.1:51375:online <span class="comment">#1</span></span><br><span class="line">$&gt;[127.0.0.1:51753]127.0.0.1:51753:online <span class="comment">#2</span></span><br><span class="line">$&gt;[127.0.0.1:51979]127.0.0.1:51979:online <span class="comment">#3</span></span><br><span class="line"><span class="comment"># client2</span></span><br><span class="line">$&gt; nc 127.0.0.1 8888</span><br><span class="line">$&gt;[127.0.0.1:51753]127.0.0.1:51753:online <span class="comment">#2</span></span><br><span class="line">$&gt;[127.0.0.1:51979]127.0.0.1:51979:online <span class="comment">#3</span></span><br><span class="line"><span class="comment"># client3</span></span><br><span class="line">$&gt; nc 127.0.0.1 8888</span><br><span class="line">$&gt; [127.0.0.1:51979]127.0.0.1:51979:online <span class="comment">#3</span></span><br></pre></td></tr></table></figure>



<h3 id="10-3-用户消息广播机制"><a href="#10-3-用户消息广播机制" class="headerlink" title="10.3 用户消息广播机制"></a>10.3 用户消息广播机制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#im1</span></span><br><span class="line"><span class="comment"># server</span></span><br><span class="line">$&gt; ./server</span><br><span class="line"><span class="comment"># client1</span></span><br><span class="line">$&gt; nc 127.0.0.1 8888</span><br><span class="line">$&gt; [127.0.0.1:55858]127.0.0.1:55858:online</span><br><span class="line">$&gt; [127.0.0.1:55894]127.0.0.1:55894:online</span><br><span class="line">$&gt; [127.0.0.1:55894]127.0.0.1:55894:hello</span><br><span class="line"><span class="comment"># client2</span></span><br><span class="line">$&gt; nc 127.0.0.1 8888</span><br><span class="line">$&gt; [127.0.0.1:55894]127.0.0.1:55894:online</span><br><span class="line">$&gt; hello</span><br><span class="line">$&gt; [127.0.0.1:55894]127.0.0.1:55894:hello</span><br></pre></td></tr></table></figure>



<h3 id="10-4-用户业务层封装"><a href="#10-4-用户业务层封装" class="headerlink" title="10.4 用户业务层封装"></a>10.4 用户业务层封装</h3><h3 id="10-5-在线用户查询"><a href="#10-5-在线用户查询" class="headerlink" title="10.5 在线用户查询"></a>10.5 在线用户查询</h3><h3 id="10-6-修改用户名"><a href="#10-6-修改用户名" class="headerlink" title="10.6 修改用户名"></a>10.6 修改用户名</h3><p>定义一种消息格式</p>
<p><code>rename|newUsername</code></p>
<h3 id="10-7-超时强T"><a href="#10-7-超时强T" class="headerlink" title="10.7 超时强T"></a>10.7 超时强T</h3><p>用户的任意消息表示用户为活跃，长时间不发消息则视为超时，可强制下线。</p>
<p>那如何判断当前用户是否活跃；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实现原理</span></span><br><span class="line">当服务端能从客户端 Read到一条信息的，开启定时器；等定时器达到一定阈值的时候，则判定客户端失联</span><br></pre></td></tr></table></figure>



<h3 id="10-8-私聊"><a href="#10-8-私聊" class="headerlink" title="10.8 私聊"></a>10.8 私聊</h3><p>同修改用户名一样，也是定义一种消息格式</p>
<p><code>to|username|send message</code></p>
<h3 id="10-9-客户端"><a href="#10-9-客户端" class="headerlink" title="10.9 客户端"></a>10.9 客户端</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># build</span></span><br><span class="line">$&gt; go build -o server main.go server.go user.go</span><br><span class="line">$&gt; go build -o client client.go</span><br></pre></td></tr></table></figure>



<h2 id="11-gin"><a href="#11-gin" class="headerlink" title="11. gin"></a>11. gin</h2><h3 id="11-1-创建项目"><a href="#11-1-创建项目" class="headerlink" title="11.1 创建项目"></a>11.1 创建项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#create</span></span><br><span class="line">Environment: https://goproxy.cn,direct</span><br><span class="line"></span><br><span class="line"><span class="comment"># import "github.com/gin-gonic/gin"</span></span><br><span class="line">go mod tidy <span class="comment"># 查漏补缺,类似 npm install</span></span><br></pre></td></tr></table></figure>



<h3 id="11-2-CLD分层"><a href="#11-2-CLD分层" class="headerlink" title="11.2 CLD分层"></a>11.2 CLD分层</h3><ul>
<li>协议处理层： 支持各种协议</li>
<li>Controller： 服务的入口，负责处理路由、参数校验、请求转发</li>
<li>Logic/Service： 逻辑（服务）层，负责处理业务员逻辑</li>
<li>DAO/Repository：负责数据与存储相关功能</li>
</ul>
<h3 id="11-3-通用脚手架"><a href="#11-3-通用脚手架" class="headerlink" title="11.3 通用脚手架"></a>11.3 通用脚手架</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">go_boilerplate</span><br><span class="line">├── config.yaml <span class="comment"># 全局配置器</span></span><br><span class="line">├── dao         <span class="comment"># dao层</span></span><br><span class="line">│   ├── mysql</span><br><span class="line">│   │   └── mysql.go</span><br><span class="line">│   └── redis</span><br><span class="line">│       └── redis.go</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── logger <span class="comment"># 日志</span></span><br><span class="line">│   └── logger.go</span><br><span class="line">├── main.go</span><br><span class="line">├── modules <span class="comment"># modules 备用</span></span><br><span class="line">├── pkg <span class="comment"># pkg备用</span></span><br><span class="line">├── routes </span><br><span class="line">│   └── routes.go</span><br><span class="line">├── settings </span><br><span class="line">│   └── settings.go <span class="comment"># viper 配置信息</span></span><br><span class="line">└── web_app.log</span><br></pre></td></tr></table></figure>





<p>一个新的项目，从程序入口main.go 开始读取；</p>
<h4 id="11-3-1-现有settings设计的问题"><a href="#11-3-1-现有settings设计的问题" class="headerlink" title="11.3.1 现有settings设计的问题"></a>11.3.1 现有settings设计的问题</h4><p>到项目后期，新接手的同事比较难一下知道项目中用到的配置信息；</p>
<p>一个优化点：</p>
<p>现在不是把配置文件读取出，之后直接保存到viper变量里面去。而是把它存储到内部定义的结构体中去。</p>
<p>什么意思呢？</p>
<p>就好比，刚开始项目是一个人开发的，他自然知道存在哪些配置。比如<code>viper.GetString(&quot;mysql.user&quot;)</code>等等；所以这里其实需要有一个类似interface的东西去提示给新开发者较好；这里选用结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> settings</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/fsnotify/fsnotify"</span></span><br><span class="line">	<span class="string">"github.com/spf13/viper"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Conf 全局变量，用来保存程序的所有配置信息</span></span><br><span class="line"><span class="keyword">var</span> Conf = <span class="built_in">new</span>(AppConfig)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AppConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name         <span class="keyword">string</span> <span class="string">`mapstructure:"name"`</span></span><br><span class="line">	Mode         <span class="keyword">string</span> <span class="string">`mapstructure:"mode"`</span></span><br><span class="line">	Version      <span class="keyword">string</span> <span class="string">`mapstructure:"version"`</span></span><br><span class="line">	Port         <span class="keyword">int</span>    <span class="string">`mapstructure:"port"`</span></span><br><span class="line">	*LogConfig   <span class="string">`mapstructure:"log"`</span></span><br><span class="line">	*MySQLConfig <span class="string">`mapstructure:"mysql"`</span></span><br><span class="line">	*RedisConfig <span class="string">`mapstructure:"redis"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LogConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Level      <span class="keyword">string</span> <span class="string">`mapstructure:"level"`</span></span><br><span class="line">	Filename   <span class="keyword">string</span> <span class="string">`mapstructure:"filename"`</span></span><br><span class="line">	MaxSize    <span class="keyword">int</span>    <span class="string">`mapstructure:"max_size"`</span></span><br><span class="line">	MaxAge     <span class="keyword">int</span>    <span class="string">`mapstructure:"max_age"`</span></span><br><span class="line">	MaxBackups <span class="keyword">int</span>    <span class="string">`mapstructure:"max_backups"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MySQLConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Host         <span class="keyword">string</span> <span class="string">`mapstructure:"host"`</span></span><br><span class="line">	User         <span class="keyword">string</span> <span class="string">`mapstructure:"user"`</span></span><br><span class="line">	Password     <span class="keyword">string</span> <span class="string">`mapstructure:"password"`</span></span><br><span class="line">	DbName       <span class="keyword">string</span> <span class="string">`mapstructure:"db_name"`</span></span><br><span class="line">	Port         <span class="keyword">int</span>    <span class="string">`mapstructure:"port"`</span></span><br><span class="line">	MaxOpenConns <span class="keyword">int</span>    <span class="string">`mapstructure:"max_open_conns"`</span></span><br><span class="line">	MaxIdleConns <span class="keyword">int</span>    <span class="string">`mapstructure:"max_idle_conns"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RedisConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Host     <span class="keyword">string</span> <span class="string">`mapstructure:"host"`</span></span><br><span class="line">	Password <span class="keyword">string</span> <span class="string">`mapstructure:"password"`</span></span><br><span class="line">	Port     <span class="keyword">int</span>    <span class="string">`mapstructure:"port"`</span></span><br><span class="line">	DB       <span class="keyword">int</span>    <span class="string">`mapstructure:"db"`</span></span><br><span class="line">	PoolSize <span class="keyword">int</span>    <span class="string">`mapstructure:"pool_size"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Init</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	viper.SetConfigFile(<span class="string">"config.yaml"</span>)</span><br><span class="line">	<span class="comment">//viper.SetConfigName("config") // 指定配置文件名称（不需要带后缀）</span></span><br><span class="line">	<span class="comment">//viper.SetConfigType("yaml")   // 指定配置文件类型(专用于从远程获取配置信息时指定配置文件类型的)</span></span><br><span class="line">	viper.AddConfigPath(<span class="string">"."</span>)   <span class="comment">// 指定查找配置文件的路径（这里使用相对路径）</span></span><br><span class="line">	err = viper.ReadInConfig() <span class="comment">// 读取配置信息</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// 读取配置信息失败</span></span><br><span class="line">		fmt.Printf(<span class="string">"viper.ReadInConfig() failed, err:%v\n"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 把读取到的配置信息反序列化到 Conf 变量中</span></span><br><span class="line">	<span class="keyword">if</span> err := viper.Unmarshal(Conf); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"viper.Unmarshal failed, err:%v\n"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	viper.WatchConfig()</span><br><span class="line">	viper.OnConfigChange(<span class="function"><span class="keyword">func</span><span class="params">(in fsnotify.Event)</span></span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"配置文件修改了..."</span>)</span><br><span class="line">		<span class="keyword">if</span> err := viper.Unmarshal(Conf); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"viper.Unmarshal failed, err:%v\n"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>增加结构体之后的流程</strong></p>
<ol>
<li>程序启动时，还是使用viper从配置文件里面去加载信息。</li>
<li>加载完信息之后，反序列化结构体变量，放到结构体中去，比如AppConfig。然后在程序中使用的是这个结构体而不是配置文件；</li>
</ol>
<h2 id="12-Gin-pro"><a href="#12-Gin-pro" class="headerlink" title="12. Gin_pro"></a>12. Gin_pro</h2><h3 id="12-1-create-sql"><a href="#12-1-create-sql" class="headerlink" title="12.1 create sql"></a>12.1 create sql</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">COLLATE</span> utf8mb4_general_ci,</span><br><span class="line">    <span class="string">`gender`</span> <span class="built_in">tinyint</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line">    <span class="string">`create_time`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="string">`update_time`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">    <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`idx_username`</span> (<span class="string">`username`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`idx_user_id`</span> (<span class="string">`user_id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_general_ci;</span><br></pre></td></tr></table></figure>



<h4 id="12-1-1-primary-key与唯一索引"><a href="#12-1-1-primary-key与唯一索引" class="headerlink" title="12.1.1 primary key与唯一索引"></a>12.1.1 primary key与唯一索引</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PRIMARY KEY (`id`),  "设置primary key"</span><br><span class="line">UNIQUE KEY `idx_username` (`username`) USING BTREE,</span><br><span class="line">UNIQUE KEY `idx_user_id` (`user_id`) USING BTREE</span><br><span class="line">"分别给 username 和 user_id 添加唯一索引"</span><br></pre></td></tr></table></figure>



<h4 id="12-1-2-user-id"><a href="#12-1-2-user-id" class="headerlink" title="12.1.2 user_id"></a>12.1.2 user_id</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">`id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">`user_id` bigint(20) NOT NULL,  "bigint(20) 占8个字节，对应go语言的int64"</span><br><span class="line">`username` varchar(64) COLLATE utf8mb4_general_ci NOT NULL,</span><br></pre></td></tr></table></figure>

<ul>
<li>为何不使用 自增的 id做 user_id，反而另外设一个字段呢</li>
</ul>
<p>原因一：那别人在你数据库里面注册一个用户，就能知道你的用户量了；</p>
<p>原因二： 当使用分库分表的时候，分成不同的库，那id可能有重复的。（因为每个表的id都自增）</p>
<ul>
<li>为何不使用uuid</li>
</ul>
<p>uuid生成出来的id 就失去了使用数字来做 用户ID的特点，int可以按照时间来排序，随着时间递增。而uuid是无规律的；检索起来也不是特别的方便。</p>
<ul>
<li>目前主流的方案</li>
</ul>
<p>大型项目一般使用分布式的ID生成器，</p>
<p><strong>分布式ID的特点</strong></p>
<ul>
<li>全局唯一性： 不能出现有重复的ID标识，这是基本要求</li>
<li>递增性： 确保生成ID对于用户或业务是递增的；</li>
<li>高可用性： 确保任何时候都能生成正确的ID</li>
<li>高性能性： 在高并发的环境下依然表现良好</li>
</ul>
<p>不仅是用于用户ID，实际互联网中有很多场景需要能够生成类似MYSQL自增ID这样不断增大，同时又不会重复的id，以支持业务中的高并发场景。</p>
<p>比较典型的场景有： 电商促销时短时间内会有大量的订单涌入到系统，比如每秒10w+；</p>
<p> 在这些业务场景下将数据插入数据库之前，我们需要给这些订单和消息先分配一个唯一ID，然后再保存到数据库中；</p>
<p> 对这个id的要求是希望其中能带有一些时间消息，这样即使我们后端的系统对消息进行了分库分表，也能够以时间顺序对这些消息进行排序；</p>
<p><strong>snowflake算法</strong></p>
<p>雪花算法，它是Twitter开源的由64位整数组成分布式ID，性能较高，并且在单机上递增</p>
<p>snowflake-64bit</p>
<p><img src="xuehua.png" alt="image-20210415181135423"></p>
<ol>
<li><strong>第一位</strong> 占用1bit，其值始终是0，没有实际作用</li>
<li><strong>时间戳</strong> 占用41bit，单位为毫秒，总共可以容纳约69年的时间，当然，我们的时间毫秒计数不会真的从1970年开始，那样我们系统跑到 2039/9/7 23:47:35 就不能用了，所以这里的时间戳只是相对于某个时间的增量，比如我们的系统上线是2020-07-01，那么我们完全可以把这个timestamp当作是从2020-07-01 00:00:00.000的偏移量</li>
<li><strong>工作机器id</strong> 占用10bit，其中高位5bit是数据中心ID，低位5bit是工作节点ID，最多可以容纳1024个节点</li>
<li><strong>序列号</strong> 占用12bit，用来记录同豪秒内产生的不同id，每个节点每豪秒0开始不断累加，最多可以累加到4095，同一豪秒一共可以产生4096个ID；</li>
</ol>
<p>snowFlake算法在同一毫秒内最多可以生成的ID数量为<strong>同一毫秒的ID数量=1024*4096 = 4194304</strong></p>
<h3 id="12-2-登陆注册流程"><a href="#12-2-登陆注册流程" class="headerlink" title="12.2 登陆注册流程"></a>12.2 登陆注册流程</h3><p>中文注释的另外一个作用，提供编码思路（有的时候面对功能模块没思路的时候，通过写注释，分析要完成需求的实际步骤）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 获取参数和参数校验</span></span><br><span class="line"><span class="comment">// 2. 业务处理</span></span><br><span class="line"><span class="comment">// 3. 返回响应</span></span><br></pre></td></tr></table></figure>

<h4 id="12-2-1-validater做参数校验"><a href="#12-2-1-validater做参数校验" class="headerlink" title="12.2.1 validater做参数校验"></a>12.2.1 validater做参数校验</h4>
          
            <div class='article_footer'>
              
                
  
    
    



  

  
    
    



  

  
    
    

<section class="widget copyright  desktop mobile">
  <div class='content'>
    
      <blockquote>
        
          
            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

          
        
          
            <p>本文永久链接是：<a href=http://yoursite.com/2021/03/16/go-web/>http://yoursite.com/2021/03/16/go-web/</a></p>
          
        
      </blockquote>
    
  </div>
</section>

  

  
    
    

<section class="widget qrcode  desktop mobile">
  

  <div class='content article-entry'>
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
  </div>
</section>

  


              
            </div>
          
        </div>
        
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2021-04-19T18:40:40+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：Apr 19, 2021</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/guide/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>guide</p></a></div>


        
      
        
          

        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=http://yoursite.com/2021/03/16/go-web/&title=go_web - Hexo&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://yoursite.com/2021/03/16/go-web/&title=go_web - Hexo&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=http://yoursite.com/2021/03/16/go-web/&title=go_web - Hexo&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png">
          
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
          <div class="prev-next">
            
              <a class='prev' href='/2021/03/24/go2/'>
                <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>go2</p>
                <p class='content'>1. io1.1 写文件按字符串写
WriteString
12345678910func main()&#123;	f, err:= os.OpenFile("./a.txt", os.O_R...</p>
              </a>
            
            
              <a class='next' href='/2021/03/16/rust/'>
                <p class='title'>rust<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
                <p class='content'>1. rust123rustc --versionrustup doc # 离线文档rustc main.rs # 编译main.rs  c为compiler

2. cargo12cargo ...</p>
              </a>
            
          </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box reveal comments shadow">
    <section class="article typo">
      <p ct><i class='fas fa-comments'></i> 评论</p>
      
      
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-cog fa-spin fa-fw fa-2x"></i>
          </div>
        </section>
      
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'go_web',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
  

  
    
    


  <section class="widget toc-wrapper shadow desktop mobile">
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-概要"><span class="toc-text">1. 概要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-处理请求"><span class="toc-text">2. 处理请求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Create-pro"><span class="toc-text">2.1 Create pro</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-如何处理web请求"><span class="toc-text">2.2 如何处理web请求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-创建web-Server"><span class="toc-text">2.2.1 创建web Server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-DefaultServeMux"><span class="toc-text">2.2.2 DefaultServeMux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-Handler-函数-http-HandleFunc"><span class="toc-text">2.2.3 Handler 函数 - http.HandleFunc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4-五个内置handler"><span class="toc-text">2.2.4 五个内置handler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-5-Request"><span class="toc-text">2.2.5 Request</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5-1-HTTP消息"><span class="toc-text">2.2.5.1 HTTP消息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5-2-请求URL"><span class="toc-text">2.2.5.2 请求URL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5-3-URL-Query"><span class="toc-text">2.2.5.3 URL Query</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5-4-URL-Fragment"><span class="toc-text">2.2.5.4 URL Fragment</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5-5-Request-Header"><span class="toc-text">2.2.5.5 Request Header</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5-6-Request-Body"><span class="toc-text">2.2.5.6 Request Body</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5-7-查询参数（Query-Parameters）"><span class="toc-text">2.2.5.7 查询参数（Query Parameters）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-6-Form"><span class="toc-text">2.2.6 Form</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-6-1-通过表单发送请求"><span class="toc-text">2.2.6.1 通过表单发送请求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-6-2-字段"><span class="toc-text">2.2.6.2 字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-6-3-FormValue-amp-PostFormValue方法"><span class="toc-text">2.2.6.3 FormValue &amp; PostFormValue方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-6-4-上传文件（Files）"><span class="toc-text">2.2.6.4 上传文件（Files）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-6-5-POST-JSON"><span class="toc-text">2.2.6.5 POST JSON</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-7-ResponseWriter"><span class="toc-text">2.2.7 ResponseWriter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-7-1-写入到ResponseWriter"><span class="toc-text">2.2.7.1 写入到ResponseWriter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-7-2-WriteHeader方法"><span class="toc-text">2.2.7.2 WriteHeader方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-7-3-Header方法"><span class="toc-text">2.2.7.3 Header方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-7-4-内置的Response"><span class="toc-text">2.2.7.4 内置的Response</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-connect-sql"><span class="toc-text">3.connect sql</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Open"><span class="toc-text">3.1 Open</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-如何获得驱动"><span class="toc-text">3.2 如何获得驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-下载驱动"><span class="toc-text">3.3 下载驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-PingContext"><span class="toc-text">3.4 PingContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-查询"><span class="toc-text">3.5 查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-1-Query"><span class="toc-text">3.5.1 Query</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-2-QueryRow"><span class="toc-text">3.5.2 QueryRow</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-更新"><span class="toc-text">3.6 更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-其它"><span class="toc-text">3.7 其它</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-路由"><span class="toc-text">4. 路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-json"><span class="toc-text">5. json</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-类型映射"><span class="toc-text">5.1 类型映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-未知结构的JSON如何映射"><span class="toc-text">5.2 未知结构的JSON如何映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-读取JSON"><span class="toc-text">5.3 读取JSON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-写入JSON"><span class="toc-text">5.4 写入JSON</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-中间件"><span class="toc-text">6. 中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-创建中间件"><span class="toc-text">6.1 创建中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-使用请求上下文"><span class="toc-text">6.2 使用请求上下文</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-HTTPS"><span class="toc-text">7. HTTPS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-HTTP-ListenAndServeTLS"><span class="toc-text">7.1 HTTP.ListenAndServeTLS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-HTTP-2"><span class="toc-text">8. HTTP&#x2F;2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-http2的特点"><span class="toc-text">8.1 http2的特点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-部署"><span class="toc-text">9. 部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-IM项目"><span class="toc-text">10 IM项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-构建基础server"><span class="toc-text">10.1 构建基础server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-用户上线功能"><span class="toc-text">10.2 用户上线功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-用户消息广播机制"><span class="toc-text">10.3 用户消息广播机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-用户业务层封装"><span class="toc-text">10.4 用户业务层封装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-在线用户查询"><span class="toc-text">10.5 在线用户查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-6-修改用户名"><span class="toc-text">10.6 修改用户名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-7-超时强T"><span class="toc-text">10.7 超时强T</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-8-私聊"><span class="toc-text">10.8 私聊</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-9-客户端"><span class="toc-text">10.9 客户端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-gin"><span class="toc-text">11. gin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-创建项目"><span class="toc-text">11.1 创建项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-CLD分层"><span class="toc-text">11.2 CLD分层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-通用脚手架"><span class="toc-text">11.3 通用脚手架</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-3-1-现有settings设计的问题"><span class="toc-text">11.3.1 现有settings设计的问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-Gin-pro"><span class="toc-text">12. Gin_pro</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1-create-sql"><span class="toc-text">12.1 create sql</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#12-1-1-primary-key与唯一索引"><span class="toc-text">12.1.1 primary key与唯一索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-1-2-user-id"><span class="toc-text">12.1.2 user_id</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-登陆注册流程"><span class="toc-text">12.2 登陆注册流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#12-2-1-validater做参数校验"><span class="toc-text">12.2.1 validater做参数校验</span></a></li></ol></li></ol></li></ol>
    </div>
  </section>


  


</aside>


  
  <footer class="clearfix">
    <br><br>
    
      
        <div class="aplayer-container">
          

  
    <meting-js
      theme='#1BCDFC'
      autoplay='false'
      volume='0.7'
      loop='all'
      order='list'
      fixed='false'
      list-max-height='340px'
      server='netease'
      type='playlist'
      id='3175833810'
      list-folded='true'>
    </meting-js>
  


        </div>
      
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="/atom.xml"
                class="social fas fa-rss flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="mailto:me@xaoxuu.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://github.com/xaoxuu"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://music.163.com/#/user/home?id=63035382"
                class="social fas fa-headphones-alt flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        <div><p>Blog content follows the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) License</a></p>
</div>
      
    
      
        Use
        <a href="https://volantis.js.org/" target="_blank" class="codename">belief</a>
        as theme, total visits
          <span id="busuanzi_value_site_pv"><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span>
          times
        
      
    
      
        <div class='copyright'>
        <p><a href="https://xaoxuu.com" target="_blank" rel="noopener">Copyright © 2017-2020 Mr. X</a></p>

        </div>
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>


  <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.6/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      ScrollReveal().reveal('.l_main .reveal', {
        distance: '8px',
        duration: '800',
        interval: '100',
        scale: '1'
      });
    });
  </script>


  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script defer src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        }
      });
    </script>
  



  
    
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js"></script>

  
    
<script src="https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js"></script>

  









  
    
<script src="https://cdn.jsdelivr.net/npm/valine@1.4/dist/Valine.min.js"></script>

  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var meta = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var REQUIRED_FIELDS = ['nick','mail','link'];
  var requiredFields = 'nick,mail'.split(',').filter(function(item){
    return REQUIRED_FIELDS.indexOf(item) > -1
  });
  var valine = new Valine();
  function emoji(path, idx, ext) {
      return path + "/" + path + "-" + idx + "." + ext;
  }
  var emojiMaps = {};
  for (var i = 1; i <= 54; i++) {
    emojiMaps['tieba-' + i] = emoji('tieba', i, 'png');
  }
  for (var i = 1; i <= 101; i++) {
    emojiMaps['qq-' + i] = emoji('qq', i, 'gif');
  }
  for (var i = 1; i <= 116; i++) {
    emojiMaps['aru-' + i] = emoji('aru', i, 'gif');
  }
  for (var i = 1; i <= 125; i++) {
    emojiMaps['twemoji-' + i] = emoji('twemoji', i, 'png');
  }
  for (var i = 1; i <= 4; i++) {
    emojiMaps['weibo-' + i] = emoji('weibo', i, 'png');
  }
  valine.init({
    el: '#valine_container',
    meta: meta,
    
    appId: "dogUA2FSKGTo029M1SEwGROT-MdYXbMMI",
    appKey: "u0NdtQ8nvHoMdJPSYqm1LRxE",
    placeholder: "快来评论吧~",
    pageSize:'10',
    avatar:'robohash',
    lang:'zh-cn',
    visitor: 'true',
    highlight: 'true',
    mathJax: 'false',
    enableQQ: 'true',
    requiredFields: requiredFields,
    emojiCDN: 'https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/emoji/valine/',
    emojiMaps: emojiMaps
  })
  </script>





  
<script src="/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.6.5/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script>






<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-check-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-check-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-times-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-times-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>




<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  function pjax_fancybox() {
    $(".article-entry").find("img").not('.inline').not('a img').each(function () { //渲染 fancybox
      var element = document.createElement("a"); // a 标签
      $(element).attr("pjax-fancybox", "");  // 过滤 pjax
      $(element).attr("href", $(this).attr("src"));
      if ($(this).attr("data-original")) {
        $(element).attr("href", $(this).attr("data-original"));
      }
      $(element).attr("data-fancybox", "images");
      var caption = "";   // 描述信息
      if ($(this).attr('alt')) {  // 标准 markdown 描述信息
        $(element).attr('data-caption', $(this).attr('alt'));
        caption = $(this).attr('alt');
      }
      var div = document.createElement("div");
      $(div).addClass("fancybox");
      $(this).wrap(div); // 最外层套 div ，其实主要作用还是 class 样式
      var span = document.createElement("span");
      $(span).addClass("image-caption");
      $(span).text(caption); // 加描述
      $(this).after(span);  // 再套一层描述
      $(this).wrap(element);  // 最后套 a 标签
    })
    $(".article-entry").find("img").fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
      closeClick: true,
      helpers: {
        overlay: {closeClick: true}
      },
      buttons: [
        "zoom",
        "close"
      ]
    });
  };
  $(function () {
    pjax_fancybox();
  });
</script>




  <script>setLoadingBarProgress(100);</script>
</body>
</html>
